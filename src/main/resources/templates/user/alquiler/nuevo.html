<!-- src/main/resources/templates/user/alquiler/nuevo.html -->
<!DOCTYPE html>
<html lang="es"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{user/layout}">
<head>
    <title>Nuevo Alquiler</title>
</head>
<body>
<div layout:fragment="content">

    <!-- ── Page Header ── -->
    <div class="page-header">
        <div class="container">
            <nav aria-label="breadcrumb" class="mb-3">
                <ol class="breadcrumb bv-breadcrumb">
                    <li class="breadcrumb-item">
                        <a th:href="@{/user/dashboard}"><i class="bi bi-house-door me-1"></i>Inicio</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a th:href="@{/user/catalogo}">Catálogo</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a th:href="@{/user/catalogo/{id}(id=${libro.bookId})}"
                           th:text="${libro.title}">Libro</a>
                    </li>
                    <li class="breadcrumb-item active">Nuevo Alquiler</li>
                </ol>
            </nav>
            <p class="text-uppercase fw-semibold mb-2"
               style="font-size:0.72rem; letter-spacing:0.12em; color:rgba(232,184,75,0.8);">
                <i class="bi bi-cart-plus me-1"></i> Proceso de alquiler
            </p>
            <h1>Confirmar Alquiler</h1>
            <p class="lead">Selecciona el ejemplar y confirma tu solicitud.</p>
        </div>
    </div>

    <div class="container pb-5">
        <div class="row g-4 align-items-start">

            <!-- ── Left Column ── -->
            <div class="col-lg-8">

                <!-- Book Info Banner -->
                <div class="book-banner bv-card mb-4 fade-up fade-up-1">
                    <div class="book-banner-cover">
                        <!-- Real cover -->
                        <img th:if="${libro.coverImageUrl != null and !#strings.isEmpty(libro.coverImageUrl)}"
                             th:src="${libro.coverImageUrl}" th:alt="${libro.title}">
                        <!-- Placeholder -->
                        <div th:unless="${libro.coverImageUrl != null and !#strings.isEmpty(libro.coverImageUrl)}"
                             class="cover-placeholder">
                            <i class="bi bi-book-half"></i>
                        </div>
                    </div>
                    <div class="book-banner-info">
                        <span class="book-cat mb-2 d-inline-block"
                              th:text="${libro.category != null ? libro.category.categoryName : 'Sin categoría'}">
                            Categoría
                        </span>
                        <h3 class="book-banner-title" th:text="${libro.title}">Título del libro</h3>
                        <p class="book-banner-author">
                            <i class="bi bi-person me-1"></i>
                            <span th:text="${libro.author != null ? libro.author.fullName : 'Autor desconocido'}">Autor</span>
                        </p>
                        <div class="d-flex gap-2 flex-wrap mt-2">
                            <span class="bv-chip">
                                <i class="bi bi-upc me-1"></i>
                                <span th:text="${libro.isbn}">ISBN</span>
                            </span>
                            <span class="bv-chip available">
                                <i class="bi bi-layers me-1"></i>
                                <span th:text="${ejemplaresDisponibles != null ? #lists.size(ejemplaresDisponibles) : 0}">0</span>
                                ejemplares disponibles
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Empty state -->
                <div th:if="${ejemplaresDisponibles == null or #lists.isEmpty(ejemplaresDisponibles)}"
                     class="bv-card fade-up fade-up-2">
                    <div class="empty-state py-5">
                        <i class="bi bi-inbox" style="color:var(--gold);"></i>
                        <p class="fw-semibold" style="color:var(--ink);">No hay ejemplares disponibles</p>
                        <p style="font-size:0.85rem;">Este libro no tiene copias disponibles por el momento.</p>
                        <a th:href="@{/user/catalogo}" class="btn-bv-ghost">
                            <i class="bi bi-arrow-left"></i> Volver al catálogo
                        </a>
                    </div>
                </div>

                <!-- Ejemplares + Form -->
                <div th:unless="${ejemplaresDisponibles == null or #lists.isEmpty(ejemplaresDisponibles)}">

                    <form th:action="@{/user/alquiler/crear}" method="post" id="alquilerForm">
                        <input type="hidden" name="bookCopyId" id="selectedBookCopyId" required>

                        <!-- Section title -->
                        <div class="section-label fade-up fade-up-2">
                            <i class="bi bi-grid-3x3 me-2" style="color:var(--gold);"></i>
                            Selecciona un ejemplar
                        </div>

                        <!-- Copy cards grid -->
                        <div class="row g-3 mb-4 fade-up fade-up-2">
                            <div th:each="ejemplar : ${ejemplaresDisponibles}" class="col-sm-6">
                                <div class="copy-card"
                                     th:attr="data-id=${ejemplar.bookCopyId}"
                                     onclick="selectCopy(this)">
                                    <div class="copy-card-header">
                                        <span class="copy-code">
                                            <i class="bi bi-hash"></i>
                                            <code th:text="${#strings.substring(ejemplar.bookCopyId.toString(), 0, 8)}">12345678</code>
                                        </span>
                                        <span class="copy-avail-badge">
                                            <i class="bi bi-circle-fill" style="font-size:6px;"></i> Disponible
                                        </span>
                                    </div>
                                    <p class="copy-notes">
                                        <i class="bi bi-info-circle me-1"></i>
                                        <span th:if="${ejemplar.notes}" th:text="${ejemplar.notes}">Notas</span>
                                        <span th:unless="${ejemplar.notes}">Ejemplar en óptimas condiciones</span>
                                    </p>
                                    <!-- Selection indicator -->
                                    <div class="copy-check">
                                        <i class="bi bi-check2"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Terms -->
                        <div class="terms-row fade-up fade-up-3">
                            <div class="form-check d-flex align-items-center gap-2">
                                <input class="form-check-input terms-check" type="checkbox" id="terms">
                                <label class="form-check-label" for="terms" style="font-size:0.875rem; color:var(--slate); cursor:pointer;">
                                    Acepto los
                                    <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal"
                                       style="color:var(--gold); font-weight:600; text-decoration:none;">
                                        términos y condiciones de alquiler
                                    </a>
                                </label>
                            </div>
                        </div>

                        <!-- Submit -->
                        <div class="fade-up fade-up-4">
                            <button type="submit" class="btn-submit-alquiler" id="submitBtn" disabled>
                                <i class="bi bi-check-circle-fill"></i>
                                Confirmar Alquiler
                            </button>
                        </div>

                    </form>
                </div>
            </div>

            <!-- ── Right Column: Summary ── -->
            <div class="col-lg-4 fade-up fade-up-2">
                <div class="bv-card summary-card" style="position:sticky; top:88px;">
                    <div class="bv-card-header">
                        <h5><i class="bi bi-receipt" style="color:var(--gold-lt);"></i> Resumen del alquiler</h5>
                    </div>
                    <div class="p-4">
                        <div class="summary-row">
                            <span class="summary-label">Título</span>
                            <span class="summary-value fw-semibold" th:text="${libro.title}">—</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Duración</span>
                            <span class="summary-value">7 días</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Tarifa diaria</span>
                            <span class="summary-value" style="color:var(--moss); font-weight:600;">$5.00</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Ejemplar</span>
                            <span class="summary-value" id="summaryEjemplar" style="color:var(--slate); font-style:italic;">
                                Sin seleccionar
                            </span>
                        </div>

                        <div class="summary-divider"></div>

                        <div class="summary-total-row">
                            <span class="summary-label">Total estimado</span>
                            <span class="summary-total">$35.00</span>
                        </div>

                        <div class="summary-note">
                            <i class="bi bi-clock me-2" style="color:var(--gold);"></i>
                            El pago se realiza al momento de devolver el libro.
                        </div>

                        <!-- Progress steps -->
                        <div class="steps mt-4">
                            <div class="step" id="step1">
                                <div class="step-icon"><i class="bi bi-layers"></i></div>
                                <span>Selecciona ejemplar</span>
                            </div>
                            <div class="step-connector"></div>
                            <div class="step" id="step2">
                                <div class="step-icon"><i class="bi bi-check2-square"></i></div>
                                <span>Acepta términos</span>
                            </div>
                            <div class="step-connector"></div>
                            <div class="step" id="step3">
                                <div class="step-icon"><i class="bi bi-bag-check"></i></div>
                                <span>Confirmar</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- ── Modal Términos ── -->
    <div class="modal fade" id="termsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content" style="border-radius:16px; border:1px solid var(--border); overflow:hidden;">
                <div class="modal-header" style="background:var(--ink); color:white; border:none; padding:20px 24px;">
                    <h5 class="modal-title" style="font-family:'Playfair Display',serif; font-size:1.1rem;">
                        <i class="bi bi-file-text me-2" style="color:var(--gold-lt);"></i>
                        Términos y Condiciones de Alquiler
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="padding:24px;">
                    <ul class="list-unstyled mb-0">
                        <li class="terms-item"><i class="bi bi-check-circle-fill"></i> El plazo de alquiler es de 7 días corridos.</li>
                        <li class="terms-item"><i class="bi bi-check-circle-fill"></i> El costo es de $5.00 por día de alquiler.</li>
                        <li class="terms-item"><i class="bi bi-check-circle-fill"></i> El pago se realiza al momento de devolver el libro.</li>
                        <li class="terms-item"><i class="bi bi-check-circle-fill"></i> Se aplican cargos adicionales por retraso en la devolución.</li>
                        <li class="terms-item"><i class="bi bi-check-circle-fill"></i> El libro debe devolverse en las mismas condiciones en que fue entregado.</li>
                    </ul>
                </div>
                <div class="modal-footer" style="border-top:1px solid var(--border); padding:16px 24px;">
                    <button type="button" class="btn-bv-primary" data-bs-dismiss="modal">
                        <i class="bi bi-check2"></i> Entendido
                    </button>
                </div>
            </div>
        </div>
    </div>

</div><!-- /fragment -->
</body>
</html>

<!-- ── Page styles ── -->
<th:block layout:fragment="extra-css">
<style>
    /* ── Breadcrumb in dark header ── */
    .bv-breadcrumb .breadcrumb-item a {
        color: rgba(255,255,255,0.5); text-decoration:none;
        font-size:0.8rem; transition:color 0.2s;
    }
    .bv-breadcrumb .breadcrumb-item a:hover { color:var(--gold-lt); }
    .bv-breadcrumb .breadcrumb-item.active { color:rgba(255,255,255,0.75); font-size:0.8rem; }
    .bv-breadcrumb .breadcrumb-item+.breadcrumb-item::before { color:rgba(255,255,255,0.25); }

    /* ── Book Banner ── */
    .book-banner {
        display: flex;
        gap: 0;
        overflow: hidden;
    }
    .book-banner-cover {
        width: 100px;
        flex-shrink: 0;
        background: linear-gradient(160deg, var(--ink), #2d2520);
        display: flex; align-items: center; justify-content: center;
    }
    .book-banner-cover img {
        width: 100%; height: 100%;
        object-fit: cover; display: block;
    }
    .cover-placeholder i {
        font-size: 2.5rem;
        color: rgba(200,148,26,0.35);
    }
    .book-banner-info {
        padding: 1.4rem 1.5rem;
        flex: 1;
    }
    .book-banner-title {
        font-family: 'Playfair Display', serif;
        font-size: 1.2rem; font-weight: 700;
        color: var(--ink); margin-bottom: 0.3rem;
        line-height: 1.3;
    }
    .book-banner-author {
        font-size: 0.85rem; color: var(--slate); margin-bottom: 0;
    }

    /* Chips */
    .bv-chip {
        font-size: 0.72rem; font-weight: 600;
        padding: 4px 10px; border-radius: 6px;
        background: rgba(90,100,114,0.08);
        color: var(--slate);
        display: inline-flex; align-items: center; gap: 4px;
    }
    .bv-chip.available {
        background: rgba(61,107,79,0.1);
        color: var(--moss);
    }

    /* ── Section label ── */
    .section-label {
        font-size: 0.8rem; font-weight: 700;
        text-transform: uppercase; letter-spacing: 0.07em;
        color: var(--slate); margin-bottom: 0.85rem;
        display: flex; align-items: center;
    }

    /* ── Copy Card ── */
    .copy-card {
        background: white;
        border: 1.5px solid var(--border);
        border-radius: var(--radius);
        padding: 1rem 1.1rem;
        cursor: pointer;
        transition: border-color 0.2s, box-shadow 0.2s, background 0.2s;
        position: relative;
        overflow: hidden;
    }
    .copy-card:hover {
        border-color: rgba(200,148,26,0.5);
        box-shadow: 0 4px 16px rgba(200,148,26,0.12);
    }
    .copy-card.selected {
        border-color: var(--gold);
        background: rgba(200,148,26,0.04);
        box-shadow: 0 4px 16px rgba(200,148,26,0.18);
    }
    .copy-card-header {
        display: flex; justify-content: space-between;
        align-items: center; margin-bottom: 0.5rem;
    }
    .copy-code {
        font-size: 0.8rem; color: var(--slate);
        display: flex; align-items: center; gap: 4px;
    }
    .copy-code code {
        background: var(--cream); color: var(--sienna);
        padding: 2px 7px; border-radius: 5px;
        font-size: 0.78rem; font-weight: 600;
    }
    .copy-avail-badge {
        font-size: 0.68rem; font-weight: 700;
        text-transform: uppercase; letter-spacing: 0.05em;
        color: var(--moss); background: rgba(61,107,79,0.1);
        padding: 3px 8px; border-radius: 5px;
        display: flex; align-items: center; gap: 5px;
    }
    .copy-notes {
        font-size: 0.8rem; color: #9a908a; margin: 0;
    }
    /* Hidden check mark, shown when selected */
    .copy-check {
        position: absolute; top: 10px; right: 10px;
        width: 22px; height: 22px;
        background: var(--gold);
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        color: white; font-size: 0.75rem; font-weight: 700;
        opacity: 0; transform: scale(0.5);
        transition: opacity 0.2s, transform 0.2s;
    }
    .copy-card.selected .copy-check {
        opacity: 1; transform: scale(1);
    }
    .copy-card.selected .copy-card-header { padding-right: 28px; }

    /* ── Terms row ── */
    .terms-row {
        background: var(--cream);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 14px 18px;
        margin-bottom: 1.25rem;
    }
    .terms-check {
        border-color: var(--border);
        cursor: pointer;
    }
    .terms-check:checked {
        background-color: var(--gold);
        border-color: var(--gold);
    }
    .terms-check:focus { box-shadow: 0 0 0 3px rgba(200,148,26,0.15); }

    /* ── Submit button ── */
    .btn-submit-alquiler {
        width: 100%;
        background: linear-gradient(135deg, var(--gold), #a07010);
        color: white; border: none;
        border-radius: 10px; padding: 14px;
        font-size: 1rem; font-weight: 700;
        font-family: 'DM Sans', sans-serif;
        letter-spacing: 0.02em; cursor: pointer;
        transition: all 0.25s ease;
        display: flex; align-items: center;
        justify-content: center; gap: 9px;
    }
    .btn-submit-alquiler:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 28px rgba(200,148,26,0.4);
    }
    .btn-submit-alquiler:disabled {
        opacity: 0.4; cursor: not-allowed;
        background: rgba(90,100,114,0.15);
        color: var(--slate); box-shadow: none; transform: none;
    }

    /* ── Summary Card ── */
    .summary-row {
        display: flex; justify-content: space-between;
        align-items: flex-start; gap: 1rem;
        margin-bottom: 0.85rem;
    }
    .summary-label {
        font-size: 0.72rem; font-weight: 700;
        text-transform: uppercase; letter-spacing: 0.06em;
        color: var(--slate); white-space: nowrap; flex-shrink: 0;
    }
    .summary-value {
        font-size: 0.875rem; color: var(--ink);
        text-align: right;
    }
    .summary-divider {
        height: 1px; background: var(--border); margin: 1rem 0;
    }
    .summary-total-row {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 1rem;
    }
    .summary-total {
        font-family: 'Playfair Display', serif;
        font-size: 1.75rem; font-weight: 700;
        color: var(--moss);
    }
    .summary-note {
        font-size: 0.78rem; color: var(--slate);
        background: var(--cream); border: 1px solid var(--border);
        border-radius: 8px; padding: 10px 13px;
        line-height: 1.5;
    }

    /* ── Steps ── */
    .steps {
        display: flex; align-items: center; gap: 0;
    }
    .step {
        display: flex; flex-direction: column;
        align-items: center; gap: 5px; flex: 1;
    }
    .step-icon {
        width: 32px; height: 32px; border-radius: 50%;
        background: rgba(90,100,114,0.1);
        border: 1.5px solid var(--border);
        display: flex; align-items: center; justify-content: center;
        font-size: 0.85rem; color: var(--slate);
        transition: all 0.3s;
    }
    .step span {
        font-size: 0.65rem; font-weight: 600;
        text-transform: uppercase; letter-spacing: 0.05em;
        color: var(--slate); text-align: center;
        transition: color 0.3s;
    }
    .step.done .step-icon {
        background: linear-gradient(135deg, var(--gold), var(--sienna));
        border-color: transparent; color: white;
    }
    .step.done span { color: var(--gold); }
    .step-connector {
        flex: 0 0 24px; height: 1.5px;
        background: var(--border); margin-bottom: 18px;
        transition: background 0.3s;
    }

    /* ── Terms modal list ── */
    .terms-item {
        display: flex; align-items: flex-start; gap: 10px;
        font-size: 0.875rem; color: var(--slate);
        padding: 8px 0; border-bottom: 1px solid var(--border);
    }
    .terms-item:last-child { border-bottom: none; }
    .terms-item i { color: var(--moss); flex-shrink: 0; margin-top: 2px; }

    /* Category chip reuse from lista */
    .book-cat {
        font-size: 0.68rem; font-weight: 700;
        text-transform: uppercase; letter-spacing: 0.08em;
        color: var(--gold); background: rgba(200,148,26,0.1);
        padding: 3px 8px; border-radius: 4px;
    }
</style>
</th:block>

<!-- ── JS ── -->
<th:block layout:fragment="extra-scripts">
<script>
    let selectedCopy = null;

    function selectCopy(element) {
        if (selectedCopy) selectedCopy.classList.remove('selected');
        element.classList.add('selected');
        selectedCopy = element;

        const copyId = element.getAttribute('data-id');
        document.getElementById('selectedBookCopyId').value = copyId;

        // Update summary
        const code = element.querySelector('code').textContent;
        document.getElementById('summaryEjemplar').textContent = '#' + code;
        document.getElementById('summaryEjemplar').style.fontStyle = 'normal';
        document.getElementById('summaryEjemplar').style.color = 'var(--ink)';

        updateSteps();
        checkSubmitButton();
    }

    document.getElementById('terms').addEventListener('change', function () {
        updateSteps();
        checkSubmitButton();
    });

    function checkSubmitButton() {
        const termsChecked = document.getElementById('terms').checked;
        const copySelected = selectedCopy !== null;
        document.getElementById('submitBtn').disabled = !(termsChecked && copySelected);
    }

    function updateSteps() {
        const copySelected = selectedCopy !== null;
        const termsChecked = document.getElementById('terms').checked;

        document.getElementById('step1').classList.toggle('done', copySelected);
        document.getElementById('step2').classList.toggle('done', termsChecked);
        document.getElementById('step3').classList.toggle('done', copySelected && termsChecked);
    }
</script>
</th:block>