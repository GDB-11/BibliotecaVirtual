<!-- src/main/resources/templates/user/catalogo/lista.html -->
<!DOCTYPE html>
<html lang="es"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{user/layout}">
<head>
    <title>Catálogo de Libros</title>
</head>
<body>
<div layout:fragment="content">

    <!-- ── Page Header ── -->
    <div class="page-header">
        <div class="container">
            <p class="text-uppercase fw-semibold mb-2"
               style="font-size:0.72rem; letter-spacing:0.12em; color:rgba(232,184,75,0.8);">
                <i class="bi bi-grid-3x3-gap-fill me-1"></i> Colección
            </p>
            <h1>Catálogo de Libros</h1>
            <p class="lead">Explora todos los títulos disponibles en nuestra biblioteca.</p>
        </div>
    </div>

    <div class="container pb-5">

        <!-- ── Filtros ── -->
        <div class="bv-card mb-5 fade-up fade-up-1">
            <div class="bv-card-header">
                <h5><i class="bi bi-funnel" style="color:var(--gold-lt);"></i> Filtrar Títulos</h5>
            </div>
            <div class="p-4">
                <form method="get" th:action="@{/user/catalogo}">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-5">
                            <label class="form-label" for="search">Buscar título</label>
                            <div style="position:relative;">
                                <i class="bi bi-search"
                                   style="position:absolute; left:13px; top:50%; transform:translateY(-50%);
                                          color:var(--slate); font-size:0.9rem; pointer-events:none;"></i>
                                <input type="text" class="form-control" id="search" name="search"
                                       placeholder="Ej: Don Quijote..." th:value="${search}"
                                       style="padding-left:36px;">
                            </div>
                        </div>
                        <div class="col-md-5">
                            <label class="form-label" for="categoryId">Categoría</label>
                            <select class="form-select" id="categoryId" name="categoryId">
                                <option value="">Todas las categorías</option>
                                <option th:each="cat : ${categorias}"
                                        th:value="${cat.categoryId}"
                                        th:text="${cat.categoryName}"
                                        th:selected="${categoryId == cat.categoryId}">
                                </option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn-bv-primary w-100" style="justify-content:center;">
                                <i class="bi bi-funnel"></i> Filtrar
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- ── Resultados — Estado vacío ── -->
        <div th:if="${libros == null or #lists.isEmpty(libros)}"
             class="bv-card fade-up fade-up-2">
            <div class="empty-state py-5">
                <i class="bi bi-search" style="color:var(--gold);"></i>
                <p class="fw-semibold" style="color:var(--ink);">No se encontraron libros</p>
                <p style="font-size:0.85rem;">Prueba con otros términos o explora todas las categorías.</p>
                <a th:href="@{/user/catalogo}" class="btn-bv-ghost" style="font-size:0.82rem;">
                    <i class="bi bi-x-circle"></i> Limpiar filtros
                </a>
            </div>
        </div>

        <!-- ── Grid de libros ── -->
        <div th:unless="${libros == null or #lists.isEmpty(libros)}">

            <!-- Contador -->
            <p class="mb-3 fade-up fade-up-1"
               style="font-size:0.8rem; color:var(--slate); letter-spacing:0.03em;"
               th:if="${totalItems > 0}">
                Mostrando <strong th:text="${#lists.size(libros)}">0</strong>
                de <strong th:text="${totalItems}">0</strong> libros encontrados
            </p>

            <div class="row g-4 fade-up fade-up-2">
                <div th:each="libro : ${libros}" class="col-sm-6 col-lg-4 d-flex">
                    <div class="book-card w-100">

                        <!-- Cover image OR spine+placeholder -->
                        <div th:if="${libro.coverImageUrl != null and !#strings.isEmpty(libro.coverImageUrl)}"
                             class="book-cover-thumb">
                            <img th:src="${libro.coverImageUrl}" th:alt="${libro.title}">
                        </div>
                        <div th:unless="${libro.coverImageUrl != null and !#strings.isEmpty(libro.coverImageUrl)}"
                             class="book-spine"></div>

                        <div class="book-body">
                            <!-- Category badge -->
                            <span class="book-cat"
                                  th:text="${libro.category != null ? libro.category.categoryName : 'Sin categoría'}">
                                Categoría
                            </span>

                            <!-- Title & Author -->
                            <h5 class="book-title" th:text="${libro.title}">Título del libro</h5>
                            <p class="book-author">
                                <i class="bi bi-person me-1"></i>
                                <span th:text="${libro.author != null ? libro.author.fullName : 'Autor desconocido'}">
                                    Autor
                                </span>
                            </p>

                            <!-- Description -->
                            <p class="book-desc"
                               th:text="${libro.description != null ? #strings.abbreviate(libro.description, 110) : 'Sin descripción disponible.'}">
                                Descripción...
                            </p>

                            <!-- Footer: ISBN + CTA -->
                            <div class="book-footer">
                                <span class="book-isbn">
                                    <i class="bi bi-upc me-1"></i>
                                    <span th:text="${libro.isbn}">ISBN</span>
                                </span>
                                <a th:href="@{/user/catalogo/{id}(id=${libro.bookId})}"
                                   class="btn-bv-ghost" style="font-size:0.78rem; padding:6px 14px;">
                                    Ver detalles <i class="bi bi-arrow-right"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ── Paginación ── -->
            <nav th:if="${totalPages > 1}" class="mt-5 d-flex justify-content-center fade-up fade-up-3">
                <ul class="pagination">
                    <li class="page-item" th:classappend="${currentPage == 1} ? 'disabled'">
                        <a class="page-link"
                           th:href="@{/user/catalogo(page=${currentPage - 1}, search=${search}, categoryId=${categoryId})}">
                            <i class="bi bi-chevron-left"></i>
                        </a>
                    </li>
                    <li th:each="i : ${#numbers.sequence(1, totalPages)}"
                        class="page-item" th:classappend="${i == currentPage} ? 'active'">
                        <a class="page-link"
                           th:href="@{/user/catalogo(page=${i}, search=${search}, categoryId=${categoryId})}"
                           th:text="${i}">1</a>
                    </li>
                    <li class="page-item" th:classappend="${currentPage == totalPages} ? 'disabled'">
                        <a class="page-link"
                           th:href="@{/user/catalogo(page=${currentPage + 1}, search=${search}, categoryId=${categoryId})}">
                            <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>

        </div><!-- /resultados -->
    </div><!-- /container -->
</div><!-- /fragment -->
</body>
</html>

<!-- ── Book card styles (via extra-css) ─────────────────────── -->
<th:block layout:fragment="extra-css">
<style>
    /* Book Card */
    .book-card {
        background: white;
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        overflow: hidden;
        display: flex;
        flex-direction: row;
        box-shadow: var(--shadow-sm);
        transition: transform 0.25s ease, box-shadow 0.25s ease;
    }
    .book-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-md);
    }

    /* Real cover thumbnail (when coverImageUrl exists) */
    .book-cover-thumb {
        width: 80px;
        flex-shrink: 0;
        overflow: hidden;
        border-radius: var(--radius-lg) 0 0 var(--radius-lg);
    }
    .book-cover-thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    /* Fallback spine (when no coverImageUrl) */
    .book-spine {
        width: 6px;
        flex-shrink: 0;
        background: linear-gradient(180deg, var(--gold), var(--sienna));
        border-radius: var(--radius-lg) 0 0 var(--radius-lg);
    }

    .book-body {
        padding: 1.25rem 1.25rem 1rem;
        display: flex;
        flex-direction: column;
        flex: 1;
        min-width: 0;
    }

    .book-cat {
        font-size: 0.68rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--gold);
        background: rgba(200,148,26,0.1);
        padding: 3px 8px;
        border-radius: 4px;
        display: inline-block;
        margin-bottom: 0.65rem;
        align-self: flex-start;
    }

    .book-title {
        font-family: 'Playfair Display', serif;
        font-size: 1rem;
        font-weight: 700;
        color: var(--ink);
        margin-bottom: 0.3rem;
        line-height: 1.35;
        /* Clamp to 2 lines */
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .book-author {
        font-size: 0.8rem;
        color: var(--slate);
        margin-bottom: 0.75rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .book-desc {
        font-size: 0.82rem;
        color: #7a7069;
        line-height: 1.6;
        flex: 1;
        margin-bottom: 1rem;
    }

    .book-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding-top: 0.75rem;
        border-top: 1px solid var(--border);
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .book-isbn {
        font-size: 0.7rem;
        color: #aaa09a;
        font-variant-numeric: tabular-nums;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 120px;
    }
</style>
</th:block>